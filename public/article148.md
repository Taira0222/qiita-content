---
title: 【Rails】flashが消えない理由とその対処法
tags:
  - Ruby
  - 初心者
  - Railsチュートリアル
  - 未経験エンジニア
  - 独学
private: false
updated_at: '2025-02-24T11:51:49+09:00'
id: b0e796e1371670e154f0
organization_url_name: null
slide: false
ignorePublish: false
---
# はじめに

こんにちは。アメリカにて独学でエンジニアを目指している者です。
Railsのflash機能について、画面をまたいだ一時的なメッセージの表示に重宝します。
しかし、アプリケーションの開発中に「意図せずフラッシュメッセージが消えない」という問題に遭遇することがあります。本記事では、そのよくある原因と解決策をご紹介します。

---

## flashとflash.nowの仕組み

### flash

- **リダイレクトを伴う操作で利用することが多い**。
- 一度設定すると、**次のリクエストまでメッセージが保持される**。
- そのため、`redirect_to`を利用してページが切り替わった先でもメッセージを表示できる。
- 新たなリクエストが発生した段階で、フラッシュメッセージは自動的に消える。

### flash.now

- **同一リクエスト内でのみ有効**。
- メッセージを即時表示するが、次のリクエストには引き継がれない。
- そのため、`render`でエラーページを再表示するときなどに使われることが多い。

---

## flashが消えない主な原因

### 原因1: 同じリクエスト内でrenderを使っているのにflashを設定している

たとえば、コントローラでログインエラーを表示するケースを考えてみます。

```ruby
if user && user.authenticate(params[:password])
  # ログイン成功
  redirect_to user_path(user)
else
  # ログイン失敗
  flash[:danger] = 'メールアドレスかパスワードが違います'
  render 'new'
end
```

この例では、ログイン失敗時に`flash[:danger]`を使ってメッセージを設定していますが、同じリクエスト内で`render 'new'`しているため、次に別のページへアクセスした際にもメッセージが残り続けてしまうことがあります。本来であれば

```ruby
flash.now[:danger] = 'メールアドレスかパスワードが違います'
```

とすることで、今のリクエストだけにエラーメッセージを表示し、次のリクエストには引き継がれなくなります。

### 原因2: renderとredirectの使い分けの混乱

Railsでは、以下の使い分けが一般的です。

- **成功時: ****`redirect_to`**** + ****`flash`**
  - 新たなリクエストでメッセージを表示したい場合
- **失敗時: ****`render`**** + ****`flash.now`**
  - 同じページにエラーメッセージを表示したい場合

こうすることで、想定通りのタイミングでフラッシュメッセージが表示され、次のリクエストに引き継がれなくなります。

### 原因3: ビューでのフラッシュ表示ロジック

場合によっては、ビューでのフラッシュ表示部分が適切に制御されていないと、消えているはずのフラッシュが再度描画されるケースがあります。`application.html.erb`などレイアウトファイルでフラッシュを表示するコードをカスタマイズしている場合は、記述が正しいかもチェックしておきましょう。

---

## 対処法のまとめ

1. **renderする場合は****`flash.now`****を使う**
   - 次のリクエストに渡さず、その場だけでメッセージを表示したいときに使う
2. **redirectする場合は****`flash`****を使う**
   - リダイレクト先のページでフラッシュメッセージを表示したいときに使う
3. **ビュー側の表示ロジックを確認する**
   - フラッシュメッセージをどの段階で描画しているか、不要に再表示していないか

以上のポイントを守ることで、「flashが消えずに残り続ける」という不具合は解決できるはずです。しっかりとRailsの仕組みに沿ったフラッシュの使い分けを実践し、ユーザーフレンドリーなUIを提供していきましょう。

---

## まとめ

- `flash`と`flash.now`の使い分けはRailsアプリケーションの基本的な知識として覚えておきましょう。
- **リダイレクト時**に画面遷移先でもメッセージを表示したい場合 → `flash`
- **同じページを再表示**する場合 → `flash.now`

これらを適切に利用することで、フラッシュメッセージが思わぬタイミングで消えなかったり、逆に表示されなかったりする問題を防ぐことができます。

