---
title: 【Ruby】今日書いたコードの振り返り#3
tags:
  - Ruby
  - 初心者
  - each
  - 未経験エンジニア
  - 独学
private: false
updated_at: '2024-12-10T06:43:22+09:00'
id: 867024753cc614a4cf37
organization_url_name: null
slide: false
ignorePublish: false
---
## はじめに

こんにちは！アメリカの大学で語学を学びながら、独学でソフトウェアエンジニアを目指している者です。

Rubyで繰り返し処理を書く中で、「`each`の返り値」と「なぜ明示的に`return`を書く必要があるのか」に疑問を持ちました。

この記事では、具体的なコード例を用いて、`each`の返り値と`return`の役割について解説します。

---

### 問題のコード

次のコードを例に考えてみましょう。

```ruby
def prefix(ary, obj)
  result = []
  ary.each do |item|
    result << item
    if item == obj
      return result
    end
  end
  return result
end

p prefix([1, 2, 3, 4, 5], 3)
```

このコードは、配列`ary`の要素を順番に`result`へ追加し、`obj`が見つかった時点で`result`を返します。

`p prefix([1, 2, 3, 4, 5], 3)` を実行すると、`[1, 2, 3]`が出力されます。

しかし、最初は `return result` がなぜ必要なのか分かりませんでした。

なぜなら、`ary.each`の返り値が最後に評価された `result << item`だと考えていたためです。

---

### 最後の`return result`が必要な理由

#### `return result`を省略するとどうなるか

`obj`が見つかった場合は`if item == obj`内で`return result`が呼ばれるので問題ありません。しかし、`obj`が見つからない場合、最後に評価される値は`each`メソッドの返り値になります。

`each`は最後に評価された式ではなく、\*\*元のコレクション（`ary`）\*\*を返すメソッドです。そのため、`return result`を省略すると、`obj`が見つからない場合は元の`ary`を返してしまいます。

結果的に同じ要素が返ってくることもありますが、このメソッドが本来返したいのは`result`であり、`ary`ではありません。したがって、最後に明示的に`return result`を書いて、「このメソッドは常に`result`を返す」という意図をコードで明確にする必要があります。

---

### なぜ`each`の返り値は最後に評価された式ではなく元のコレクションなのか

ここで新たな疑問が生まれます。「`each`はなぜ`result << item`ではなく`ary`を返すのか？」

#### `each`が元のコレクションを返す理由

##### 1. **繰り返し処理が目的**

`each`は要素に対して処理を行うためのメソッドで、結果を集めることが目的ではありません。

処理を実行することがメインであるため、戻り値はシンプルに元のコレクションを返す設計になっています。

##### 2. **メソッドチェーンを可能にするため**

`each`が元のコレクションを返すことで、後続に`map`や`select`などのメソッドを続けて呼ぶことができます。

もし`each`が最後に評価された式（例えば`nil`や`result << item`）を返していたら、メソッドチェーンがしづらくなるでしょう。

##### 3. **副作用を伴う処理に便利**

`each`は標準出力やファイル出力など、副作用が目的の処理と相性がよく、返り値が元のコレクションであることで、処理結果を気にせず繰り返しを実行できます。

---

### 他の返り値について

Rubyでは`each`以外にも、さまざまな構造で返り値が決まっています。

- **メソッド**: 最後に評価された式、または`return`で指定した値が返り値
- **クラス定義**: クラス名を返す
- **モジュール定義**: モジュール名を返す
- **ブロック**: ブロック内で最後に評価された式が返り値となり、`map`や`select`などがこれを利用して結果を集計

---

### まとめ

#### 問題のコードについて

`return result`が必要な理由は、`obj`が見つからなかった場合にも`result`を返すためです。`each`の返り値が元の`ary`であるため、明示的に`result`を返すことで意図が明確になります。

#### `each`の返り値について

- `each`は最後に評価された式ではなく元のコレクションを返します。
- これは繰り返し処理に特化しており、メソッドチェーンや副作用を伴う処理に適した設計思想によるものです。

#### その他の返り値について

- メソッド、クラス、モジュール、ブロックなど、それぞれ固有の返り値のルールがあります。



