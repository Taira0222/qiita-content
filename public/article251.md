---
title: 【rails】DeviseのCookieやSessionの特性を理解する
tags:
  - Rails
  - devise
  - 初心者
  - 未経験エンジニア
  - 独学
private: false
updated_at: '2025-06-08T12:22:14+09:00'
id: c2dccc5cb85af274f261
organization_url_name: null
slide: false
ignorePublish: false
---

## はじめに

こんにちは。アメリカ在住で独学エンジニアを目指している Taira です。
現在、Rails チュートリアルのアウトプットとしてアプリを製作しています。
認証機能に`devise`を導入してアプリ開発を進めていますが、ログインやログアウト後の挙動について、開発中に少し気になる動作があったので、今回は`devise`における**Cookie と Session の特性**について整理しておこうと思います。

---

## 結論：`devise`の基本挙動

- デフォルトでは「remember_me」を使わない限り、\*\*セッション Cookie（session-only cookie）\*\*が使用される
- この Cookie は**ブラウザを完全に終了するまで残り続ける**（タブを閉じただけでは削除されない）
- `dev`  コマンドを再起動してもセッションは残り続ける(タブを閉じたのと同じ挙動となる)
- `remember_me`を使用すると、**有効期限付きの永続 Cookie**が発行され、ブラウザを閉じてもログイン状態が保持される

---

## セッション Cookie と永続 Cookie の違い

| 種類            | セッション Cookie                | 永続 Cookie                        |
| --------------- | -------------------------------- | ---------------------------------- |
| 有効期限        | ブラウザ終了で削除               | `remember_for`（例：2 週間）で指定 |
| 保存先          | メモリ上                         | ディスク上（ブラウザに保持）       |
| 用途            | 通常ログイン時                   | `remember_me`を使ったログイン      |
| Devise での動作 | タブを閉じてもログイン状態は維持 | ブラウザを閉じてもログイン継続     |

---

## なぜ「dev 再起動後もログイン状態」になるのか？

開発中、`dev`コマンドを終了して再起動しただけなのにログイン状態が継続しているように見えることがあります。

- これは**ブラウザのプロセスが生きている＝セッション Cookie が保持されている**ためです
- `dev`（Rails サーバ）の停止とは無関係に、ブラウザ側が同じ Cookie を送り続けている状態です

---

## 本番環境でのセキュリティ懸念：公共 PC での利用

たとえば公共の PC などで、

1. ユーザー A がログインし
2. タブだけ閉じて PC を離れる
3. ユーザー B が同じブラウザを開いて再アクセスする

と、**ユーザー B が A のアカウントでアクセスできてしまう**可能性があります。

### 対策方法

#### 1. `remember_me`機能を無効化

- ビューからチェックボックスを削除
- コントローラで強制的に`params[:remember_me] = "0"`と設定

しかし、同様に UX を下げることにもつながります。サービスによって`remember_me`  を導入するか判断する必要があります。

#### 2. セッションの有効期限を短くする

```ruby
# config/initializers/session_store.rb
Rails.application.config.session_store :cookie_store, key: '_your_app_session', expire_after: 30.minutes
```

#### 3. ログアウト時にセッションを完全に削除

Devise は`destroy`時に`reset_session`を呼ぶため、明示的な操作は基本不要ですが、念のためログの確認をおすすめします。

#### 4. ユーザーに「ブラウザを閉じるように」注意喚起する

- 公共 PC では、タブを閉じるだけでは不十分なことを表示などで促す
- 例：「ご利用後は必ずブラウザ全体を終了してください」

---

## まとめ

| 想定シナリオ     | 推奨設定                                   |
| ---------------- | ------------------------------------------ |
| 公共 PC での利用 | `remember_me`無効 + セッション有効期限設定 |
| 自分の端末       | `remember_me`有効でも OK（注意喚起あり）   |

`devise`の Cookie や Session の挙動を理解することで、UX か**セキュリティリスク**のどちらを優先するか、サービスによって分けることができるようになります。
