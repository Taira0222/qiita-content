---
title: 【rails】Deviseのパスワードリセット後の自動ログインに関するセキュリティ問題とその対策
tags:
  - Rails
  - devise
  - 初心者
  - 未経験エンジニア
  - 独学
private: false
updated_at: '2025-06-06T12:14:06+09:00'
id: be12383fa4fa97b6dbaa
organization_url_name: null
slide: false
ignorePublish: false
---

## はじめに

こんにちは。アメリカ在住で独学エンジニアを目指している Taira です。
現在、Rails チュートリアルのアウトプットとしてアプリを製作しています。
devise を使用して認証機能をセットアップしているのですが、とても便利な一方、あまり理解もせずに利用しているとセキュリティ面でよくない挙動をするのではないのかと思い、備忘録として記事にしようと思いました。

## パスワードリセット後の遷移先

Rails の認証ライブラリである Devise を使用していると、ユーザーがパスワードを忘れた際に、パスワードをリセットして新しいパスワードを登録した後、**自動でログインされるという動作がデフォルトで設定されています**

この仕様はユーザー体験としては便利ですが、セキュリティの観点からは注意が必要です。

---

### 【問題点】

#### 1. トークンの漏洩による不正ログインのリスク

パスワードリセットリンクはメールで送信されます。そのリンクにはセキュリティトークンが含まれており、このトークンを使えば誰でも新しいパスワードを設定し、そのままログインできてしまいます。つまり、メールが第三者に見られてしまった場合、その人が不正にログインできるリスクがあります。

#### 2. 共用端末からのアクセスによる危険性

共用のパソコンや公衆 Wi-Fi などの安全でない環境でパスワードリセットを行った場合、パスワード設定後に自動でログインされると、端末に情報が残ってしまい第三者にアカウントを乗っ取られる危険があります。

---

### 【対策】

#### 自動ログインを無効化する

Devise では、パスワードリセット後の自動ログインを無効化することが可能です。具体的には、`Devise::PasswordsController`をカスタマイズして `after_resetting_password_path_for` メソッドをオーバーライドします。

```ruby
# app/controllers/users/passwords_controller.rb
class Users::PasswordsController < Devise::PasswordsController
  protected

  # パスワード変更後にログインせず、ログイン画面にリダイレクトする
  def after_resetting_password_path_for(resource)
    new_session_path(resource_name)
  end
end
```

ルーティングもカスタムコントローラーを指定するように修正します：

```ruby
# config/routes.rb
devise_for :users, controllers: {
  passwords: 'users/passwords'
}
```

これにより、ユーザーはパスワードリセット後に自動ログインされず、ログイン画面にリダイレクトされるようになります。

---

### 【まとめ】

パスワードリセット後の自動ログインは利便性の高い機能ですが、セキュリティリスクを伴います。特にトークンの漏洩や共用端末での利用時には不正ログインのリスクが高まります。

そのため、セキュリティを重視するアプリケーションでは自動ログインを無効にし、リセット後に改めてログインさせることで、安全性を高めることが推奨されます。
