---
title: 【SQL】デッドロック
tags:
  - SQL
  - 初心者
  - デッドロック
  - 未経験エンジニア
  - 独学
private: false
updated_at: '2025-04-19T11:55:07+09:00'
id: 3318ab3cb1d5a9f41c50
organization_url_name: null
slide: false
ignorePublish: false
---
# はじめに

こんにちは。アメリカに住みながら、独学でエンジニアを目指しているTairaです。
今回は、トランザクションを勉強した際に必ず出てくるデッドロックについて、記事にしていこうと思います。

---

## デッドロックとは？

**デッドロック（Deadlock）** とは、複数のトランザクションがお互いに**相手のロック解除を待っている状態**になり、**永久に処理が進まなくなる**ことを指します。

---

## 例えばで理解

以下の2つのトランザクションが同時に動いている状況を想像してみましょう。

### ● トランザクションA
1. `users` テーブルのレコードをロック
2. 続いて `orders` テーブルを更新しようとして待機

### ● トランザクションB
1. `orders` テーブルをロック
2. 続いて `users` テーブルを更新しようとして待機

このとき、
- AはBが持っている`orders`のロックを待っている
- BはAが持っている`users`のロックを待っている

→ **お互いに待ち続けるため、永久に進まない状態 = デッドロック**

---


## なぜ問題か

- デッドロックが起きると **トランザクションが終了しない** 
- その他の処理も待たされるため、**システム全体のパフォーマンスが低下**
- 最悪の場合、システム停止やエラーの原因に

---

## 対策方法

| 方法 | 内容 |
|--------|------|
| **ロック順序を統一** | すべてのトランザクションで **同じ順番でテーブルをロック**することで、循環待機を防げる |
| **タイムアウトの設定** | 一定時間ロックが取れなければ、自動でトランザクションを中断 |
| **短時間でトランザクションを終える** | 処理を短くすることでロック保持時間を減らす |
---

## SQLでの例 (MySQL)

```sql
-- トランザクションA
START TRANSACTION;
UPDATE users SET name = 'Alice' WHERE id = 1;

-- Bがordersを先にロックしていると、Aはここで待機
UPDATE orders SET status = 'done' WHERE user_id = 1;
```

```sql
-- トランザクションB
START TRANSACTION;
UPDATE orders SET status = 'done' WHERE user_id = 1;

-- Aがusersをロックしていると、Bはここで待機
UPDATE users SET name = 'Bob' WHERE id = 1;
```

---

## まとめ

| 項目 | 内容 |
|------|------|
| 定義 | お互いのロックを待ち合って進めない状態 |
| 原因 | ロック取得順序のバラバラ、長いトランザクションなど |
| 対策 | ロック順序の統一、タイムアウト設定、再試行処理など |

